/*******************************************************
* Copyright (C) 2018-2024 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";var e={2352:(e,t,n)=>{var o;n.d(t,{$M:()=>i,Yw:()=>r}),function(e){e[e.CHROME=1]="CHROME",e[e.FIREFOX=2]="FIREFOX",e[e.EDGE=4]="EDGE",e[e.SAFARI=8]="SAFARI"}(o||(o={}));const i=!1,r=!1;i?o.FIREFOX:r?o.SAFARI:o.CHROME},3752:(e,t,n)=>{n.d(t,{Ts:()=>i,t:()=>o,wp:()=>r,zM:()=>s});const o=chrome.runtime.id,i=(chrome.runtime.getManifest().version,["bpgopfmgmnojmhnhmgpfmpnookgbmkko","oocalimimngaihdkbihfgmpkcpnmlaoa","igbncjcgfkfnfgbaieiimpfkobabmkce"]),r=108e5,s="redirectDataMap"},2390:(e,t,n)=>{n.d(t,{MG:()=>c,Pm:()=>o,bT:()=>s,gR:()=>i,pr:()=>r});const o="Service_Background",i="Content_Script",r="Iframe",s="TP_Sidebar",c=2e4},9356:(e,t,n)=>{n.d(t,{Y:()=>o});var o=console.log.bind(self.console)},7503:(e,t,n)=>{n.d(t,{Q:()=>o});class o{constructor(e,t,n){this.sender=e,this.target=t,this.type=n}}},6269:(e,t,n)=>{n.d(t,{A:()=>a});var o=n(2352),i=n(2390),r=n(3752),s=n(9356),c=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const a=new class{addListener(e){o.$M||o.Yw?browser.runtime.onMessage.addListener(e):chrome.runtime.onMessage.addListener(e),chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}sendMessageToTabAsync(e,t,n=i.MG){return c(this,void 0,void 0,(function*(){if(o.$M||o.Yw){const o=setTimeout((()=>{throw console.log("send timeout"),new Error("send timeout")}),n),i=yield browser.tabs.sendMessage(t,e);if(browser.runtime.lastError)throw(0,s.Y)(browser.runtime.lastError.message+JSON.stringify(e)),new Error(browser.runtime.lastError.message);return clearTimeout(o),i}return new Promise(((o,i)=>{const r=setTimeout((()=>{console.log("send timeout"),i("Message Timeout")}),n);try{chrome.tabs.sendMessage(t,e,(t=>{chrome.runtime.lastError&&(0,s.Y)(chrome.runtime.lastError.message+JSON.stringify(e)),clearTimeout(r),o(t)}))}catch(e){clearTimeout(r),i(e)}}))}))}i(e,t){return c(this,void 0,void 0,(function*(){return new Promise(((n,o)=>{let i=null;t&&(i=setTimeout((()=>{o({error:"Send Message Timeout"})}),t));try{chrome.runtime.sendMessage(r.t,e,(t=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(e)),i&&clearTimeout(i),n(t)}))}catch(e){i&&clearTimeout(i),o(e)}}))}))}}},8030:(e,t,n)=>{n.d(t,{s:()=>i});var o=n(7503);class i extends o.Q{constructor(e,t,n){super(e,t,n),this.type=n}}},5462:(e,t,n)=>{var o;n.d(t,{M:()=>o}),function(e){e.JOIN_SESSION="joinSession",e.ACCEPT_DROPIN="acceptDropin",e.SET_STATUS_TYPE="setStatusType",e.SET_DATA="setData",e.GET_DATA="getData",e.GET_STATUS_TYPE="getStatusType",e.GET_VIDEO_DATA="getVideoData",e.LOAD_SESSION="loadSession",e.NO_SESSION_DATA="noSessionData",e.ON_NOTIF="onNotif",e.FORWARD_TO_SIDEBAR="forwardToSidebar",e.TEARDOWN="teardown",e.ON_VIDEO_UPDATE="onVideoUpdate",e.SOCKET_LOST_CONNECTION="socketLostConnection",e.REBOOT="socketReconnect",e.LOG_EVENT="logEvent",e.LOG_EXPERIMENT="logExperiment",e.STAY_ALIVE="stayAlive",e.LOAD_CHAT_WINDOW="loadChatWindow",e.RESET_CHAT_WINDOW="resetChatWindow",e.HIDE_CHAT_WINDOW="hideChatWindow",e.SET_USER_PRESENCE="setUserPresence",e.TOGGLE_OPEN_PARTY="toggleOpenParty",e.GET_ACTIVE_PARTY="getActiveParty",e.GET_TAB_ID="getTabId",e.SET_ACTIVE_PARTY="setActiveParty",e.FULLSCREEN_WINDOW="fullscreenWindow",e.MAX_WINDOW="maxWindow",e.GET_EXPERIMENT_FLAG="getExpFlag",e.USER_LIST="userList",e.USER_AUTHENTICATED="userAuthenticated",e.BLOCK_CSP="blockCSP",e.REDIRECT_DATA_SET="redirectDataSet",e.LOAD_NETFLIX_DATA="loadNetflixData"}(o||(o={}))},7878:(e,t,n)=>{var o;n.d(t,{q:()=>o}),function(e){e.SET_USER_LIST="setUserList",e.SET_CONNECTION_ID="setConnectionId",e.LOAD_INIT_DATA="loadInitData",e.SET_PAGE_TITLE="setPageTitle",e.ADD_GIF_MESSAGE="addGifMessage",e.SIDEBAR_MESSAGING_READY="sidebarMessagingReady",e.RESET_VIEW="resetView",e.HIDE_CHAT="hideChat",e.ON_UPDATE_SETTINGS="onUpdateSettings",e.PREVIEW_REACTION="previewReaction",e.UPDATE_SETTINGS="updateSettings",e.SET_REACTIONS_ACTIVE="setReactionsActive",e.ON_FOCUS="onSidebarFocus",e.SET_USER_ICON_URL="setUserIconUrl",e.ADD_MESSAGE="addMessage",e.CLEAR_MESSAGES="clearMessages",e.SET_PRESENCE_MESSAGE="setPresenceMessage",e.ON_PAGE_CLICK="onPageClick",e.ON_PURCHASE="onPurchase",e.DISPLAY_MODAL="displayModal",e.OPEN_TAB="openTab",e.ON_CHROME_STORAGE_UPDATE="onChromeStorageUpdate",e.ON_WEB_RTC="onWebRTC"}(o||(o={}))}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e="Failed to read chrome storage. Please refresh the page and try again";var t=n(2352),o=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const i=new class{getItemAsync(e){return o(this,void 0,void 0,(function*(){return(yield chrome.storage.local.get(e))[e]}))}getItemsAsync(t){return o(this,void 0,void 0,(function*(){return new Promise(((n,o)=>{chrome.storage.local.get(t,(t=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),o(new Error(e))):n(t)}))}))}))}getStorageUse(){return o(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{chrome.storage.local.getBytesInUse(null,(o=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),n(new Error(e))):t(o)}))}))}))}getAllItemsAsync(){return o(this,void 0,void 0,(function*(){if(t.$M){return yield browser.storage.local.get()}return new Promise(((t,n)=>{chrome.storage.local.get(null,(o=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),n(new Error(e))):t(o)}))}))}))}};Object.freeze(i);const r=i;var s=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const c=new class{setItemsAsync(e){return s(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?n(new Error("Failed to write to chrome storage. Please refresh the page and try again")):t()}))}))}))}};Object.freeze(c);const a=c;var d,u=n(3752);!function(e){e.REGISTER="register",e.PARTY_START="party_start",e.PARTY_JOIN="party_join",e.PARTY_END="party_end",e.PARTY_SHARE="party_share"}(d||(d={}));var l=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const f=new class{getRedirectDataForTabAsync(e){return l(this,void 0,void 0,(function*(){const t=(yield r.getItemsAsync([u.zM])).redirectDataMap,n=this.u(e);if(t&&t[n]){const e=t[n];if(this.l(e))return e}}))}deleteRedirectDataForTabAsync(e){return l(this,void 0,void 0,(function*(){const t=(yield r.getItemsAsync([u.zM])).redirectDataMap,n=this.u(e);t&&t[n]&&delete t[n],yield a.setItemsAsync({[u.zM]:t})}))}u(e){return e}storeRedirectDataForTabAsync(e,t){return l(this,void 0,void 0,(function*(){console.log("store data for tab "+e);const n=this.u(t);let o=yield r.getItemsAsync([u.zM]);o[n]=e,o=this.h(o),yield a.setItemsAsync({[u.zM]:o})}))}h(e){return function(e,t){const n={};let o;for(o in e)e.hasOwnProperty(o)&&t(e[o])&&(n[o]=e[o]);return n}(e,this.l)}l(e){const t=e.date;return void 0!==t&&"number"==typeof t&&t<=Date.now()&&Date.now()-t<u.wp}};Object.freeze(f);const h=f,v={Q7:["*://*/*"]};var m=n(2390),w=n(8030),y=n(5462);class p extends w.s{constructor(e,t,n){super(e,t,y.M.LOG_EVENT),this.data=n,this.sender=e,this.target=t}}var g,b=n(6269);class x extends w.s{constructor(e,t,n){super(e,t,y.M.LOG_EXPERIMENT),this.data=n}}!function(e){e.DO_AUTH_SIGN_IN="doAuthSignIn",e.DO_APPLE_SIGN_IN="doAppleSignIn",e.GET_AUTH_TOKEN="getAuthToken",e.SIGN_OUT="signOut"}(g||(g={}));var T,S=n(7503);class P extends S.Q{constructor(e,t,n){super(e,t,n),this.type=n}}class A extends P{constructor(e,t){super(e,t,g.DO_AUTH_SIGN_IN)}}class D extends P{constructor(e,t){super(e,t,g.GET_AUTH_TOKEN)}}class I extends P{constructor(e,t){super(e,t,g.SIGN_OUT)}}class k extends w.s{constructor(e,t){super(e,t,y.M.GET_ACTIVE_PARTY)}}class E extends w.s{constructor(e,t,n){super(e,t,y.M.ACCEPT_DROPIN),this.data=n}}!function(e){e.WITH_ACTIVITY="with_activity",e.NO_ACTIVITY="no_activity",e.OFFLINE="offline"}(T||(T={}));class M extends w.s{constructor(e,t,n){super(e,t,y.M.SET_STATUS_TYPE),this.data=n}}class _ extends w.s{constructor(e,t,n){super(e,t,y.M.SET_DATA),this.data=n}}class O extends w.s{constructor(e,t,n){super(e,t,y.M.GET_DATA),this.data=n}}var R=n(7878),C=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};const G="https://www.netflix.com/watch/*";let j,F,N="new";function U(e){return"https://www.tele.pe"===e.origin&&(N="old"),function(e){if(null!=u.Ts.find((t=>e.origin===`chrome-extension://${t}`)))return!0;const t=e.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/);return null!=t}(e)}function V(){return C(this,void 0,void 0,(function*(){return new Promise((e=>{console.log("check has default permissions",v.Q7),chrome.permissions.contains({origins:v.Q7},(t=>{console.log(t),e(t)}))}))}))}function L(e,t){return C(this,void 0,void 0,(function*(){const n=yield $();n&&(yield h.storeRedirectDataForTabAsync(e,n));const{sessionId:o,service:i}=e,r={sessionId:o,eventType:`redirect-${N}-${i}-chrome`},s=new p(m.pr,m.Pm,r),c={name:"user_click",action:{description:`redirect-${N}-${i}-chrome`}},a=new p(m.pr,m.Pm,c);try{yield b.A.i(a,2500),yield b.A.i(s,2500)}finally{t("resolveRedirect")}}))}function $(){return C(this,void 0,void 0,(function*(){return yield b.A.i(new w.s(m.pr,m.Pm,y.M.GET_TAB_ID))}))}console.log("Connect Loaded",window.origin,window.location),navigator.serviceWorker&&navigator.serviceWorker.addEventListener("message",(e=>{console.log(e),parent.postMessage(e.data,"*")})),window.addEventListener("message",(function(e){var n;try{if(U(e)){const n=e.data;if(n&&n.type&&!n.from_connect){const o=function(e){return n=>{var o;const i=e.data,r=e.data.callbackId;if(i.callbackId){const o={callbackId:r,data:n,from_connect:!0};try{t.Yw?window.postMessage(o,e.origin):window.parent.postMessage(o,e.origin)}catch(e){}}else null===(o=window.parent)||void 0===o||o.postMessage(Object.assign(Object.assign({},n),{from_connect:!0}),e.origin)}}(e);n.target===m.gR||n.target===m.Pm?function(e,t){C(this,void 0,void 0,(function*(){const n=yield b.A.i(e);t(n)}))}(n,o):"SetRedirectData"==n.type?(console.log("Got setRedirectData message",n),t.$M&&b.A.i({sender:m.pr,target:m.Pm,type:y.M.BLOCK_CSP}),L(n.data,o)):n.sessionId?L(n,o):"GetPermissions"===n.type?function(e,t){C(this,void 0,void 0,(function*(){const n=(yield V())||(yield function(e){return C(this,void 0,void 0,(function*(){return new Promise((e=>{var t;const n=()=>C(this,void 0,void 0,(function*(){chrome.permissions.request({origins:v.Q7},(t=>{var n;null==t&&console.log(null===(n=chrome.runtime.lastError)||void 0===n?void 0:n.message),e(t)}))}));null===(t=document.querySelector("html"))||void 0===t||t.addEventListener("click",n)}))}))}(t.site));e(n)}))}(o,n.data):"CheckHasPermissions"===n.type?V().then(o):"logEvent"===n.type?function(e,t){C(this,void 0,void 0,(function*(){const n=new p(m.pr,m.Pm,e.event);try{b.A.i(n,2500)}finally{t()}}))}(n.data,o):"logExperiment"===n.type?function(e,t){C(this,void 0,void 0,(function*(){const{experimentName:n,experimentVersion:o,event:i}=e,r=new x(m.pr,m.Pm,{experimentName:n,experimentVersion:o,eventType:i});try{yield b.A.i(r,2500)}finally{t()}}))}(n.data,o):"SetPermId"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=yield r.getAllItemsAsync();t.userId||(t.userId=e)}))}(n.data):"storeExperimentVersion"===n.type?function(e,t){var n;C(this,void 0,void 0,(function*(){const{experimentName:o,experimentVersion:i}=e,s=yield r.getItemsAsync(["experiments"]),c=null!==(n=s.experiments)&&void 0!==n?n:{};c[o]=i;try{yield a.setItemsAsync({experiments:c})}finally{t()}}))}(n.data,o):"GetPermId"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=(yield r.getAllItemsAsync()).userId;e(t)}))}(o):"GetActiveNetflixTabs"===n.type?function(e){chrome.tabs.query({url:G},(t=>{e(t)}))}(o):"CloseNetflixTabs"===n.type?function(e){chrome.tabs.query({url:G},(t=>{const n=t.map((e=>e.id)).filter((e=>!!e));chrome.tabs.remove(n),e()}))}(o):"AddSidebarHandler"===n.type?t.Yw||function(e,t){C(this,void 0,void 0,(function*(){console.log("add sidebar handler"),j=e,F=yield $(),t(F)}))}(e.origin,o):"DoGoogleAuth"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=new A(m.pr,m.Pm);yield b.A.i(t),e()}))}(o):"DoSignOut"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=new I(m.pr,m.Pm);yield b.A.i(t),e()}))}(o):"GetAuthToken"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=new D(m.pr,m.Pm),n=yield b.A.i(t);e(n)}))}(o):"LoadSessionTab"===n.type?function(e,t){C(this,void 0,void 0,(function*(){chrome.tabs.create(e.tabData,(t=>C(this,void 0,void 0,(function*(){const n=t.id;n&&(yield h.storeRedirectDataForTabAsync(e.sessionData,n))}))))}))}(n.data):"GetActiveParty"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=new k(m.pr,m.Pm),n=yield b.A.i(t);e(n)}))}(o):"AcceptDropin"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=e.sessionId;b.A.i(new E(m.pr,m.Pm,{sessionId:t}))}))}(n.data):"SetStatusType"===n.type?function(e){C(this,void 0,void 0,(function*(){const t=e.type;b.A.i(new M(m.pr,m.Pm,t))}))}(n.data):"GetStatusType"==n.type?function(e){C(this,void 0,void 0,(function*(){const t=yield b.A.i(new w.s(m.pr,m.Pm,y.M.GET_STATUS_TYPE));e(t)}))}(o):"SetData"==n.type?function(e,t){C(this,void 0,void 0,(function*(){const n=yield b.A.i(new _(m.pr,m.Pm,e));t(n)}))}(n.data,o):"GetData"==n.type?function(e,t){C(this,void 0,void 0,(function*(){const n=yield b.A.i(new O(m.pr,m.Pm,e));t(n)}))}(n.data,o):console.log("Unsupported Operation "+n.type)}}}catch(t){t&&t.message.includes("Extension context invalidated")&&(null===(n=window.top)||void 0===n||n.postMessage("tp_reload",e.origin))}}),!1),b.A.addListener((function(e,n,o){var i;return e.target===m.bT&&((null===(i=n.tab)||void 0===i?void 0:i.id)===F||(t.$M||t.Yw)&&e.tabId===F)?null!=j?(window.parent.postMessage(e,j),o(),!0):(console.warn("Not ready yet"),o(),!0):(e.type===R.q.ON_PURCHASE&&null!=j&&window.parent.postMessage(e,j),!1)}))})()})();