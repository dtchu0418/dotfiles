/*******************************************************
* Copyright (C) 2018-2024 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";var e={2352:(e,n,t)=>{var o;t.d(n,{$M:()=>i,Yw:()=>r}),function(e){e[e.CHROME=1]="CHROME",e[e.FIREFOX=2]="FIREFOX",e[e.EDGE=4]="EDGE",e[e.SAFARI=8]="SAFARI"}(o||(o={}));const i=!1,r=!1;i?o.FIREFOX:r?o.SAFARI:o.CHROME},3752:(e,n,t)=>{t.d(n,{Ts:()=>i,t:()=>o,wp:()=>r,zM:()=>c});const o=chrome.runtime.id,i=(chrome.runtime.getManifest().version,["bpgopfmgmnojmhnhmgpfmpnookgbmkko","oocalimimngaihdkbihfgmpkcpnmlaoa","igbncjcgfkfnfgbaieiimpfkobabmkce"]),r=108e5,c="redirectDataMap"},2390:(e,n,t)=>{t.d(n,{MG:()=>a,Pm:()=>o,Ty:()=>s,bT:()=>c,gR:()=>i,pr:()=>r});const o="Service_Background",i="Content_Script",r="Iframe",c="TP_Sidebar",s="Connect_Script",a=2e4},9356:(e,n,t)=>{t.d(n,{Y:()=>o});var o=console.log.bind(self.console)},7503:(e,n,t)=>{t.d(n,{Q:()=>o});class o{constructor(e,n,t){this.sender=e,this.target=n,this.type=t}}},6269:(e,n,t)=>{t.d(n,{A:()=>a});var o=t(2352),i=t(2390),r=t(3752),c=t(9356),s=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const a=new class{addListener(e){o.$M||o.Yw?browser.runtime.onMessage.addListener(e):chrome.runtime.onMessage.addListener(e),chrome.runtime.onMessage.addListener(e)}removeListener(e){chrome.runtime.onMessage.removeListener(e)}sendMessageToTabAsync(e,n,t=i.MG){return s(this,void 0,void 0,(function*(){if(o.$M||o.Yw){const o=setTimeout((()=>{throw console.log("send timeout"),new Error("send timeout")}),t),i=yield browser.tabs.sendMessage(n,e);if(browser.runtime.lastError)throw(0,c.Y)(browser.runtime.lastError.message+JSON.stringify(e)),new Error(browser.runtime.lastError.message);return clearTimeout(o),i}return new Promise(((o,i)=>{const r=setTimeout((()=>{console.log("send timeout"),i("Message Timeout")}),t);try{chrome.tabs.sendMessage(n,e,(n=>{chrome.runtime.lastError&&(0,c.Y)(chrome.runtime.lastError.message+JSON.stringify(e)),clearTimeout(r),o(n)}))}catch(e){clearTimeout(r),i(e)}}))}))}i(e,n){return s(this,void 0,void 0,(function*(){return new Promise(((t,o)=>{let i=null;n&&(i=setTimeout((()=>{o({error:"Send Message Timeout"})}),n));try{chrome.runtime.sendMessage(r.t,e,(n=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message+JSON.stringify(e)),i&&clearTimeout(i),t(n)}))}catch(e){i&&clearTimeout(i),o(e)}}))}))}}},8030:(e,n,t)=>{t.d(n,{s:()=>i});var o=t(7503);class i extends o.Q{constructor(e,n,t){super(e,n,t),this.type=t}}},5462:(e,n,t)=>{var o;t.d(n,{M:()=>o}),function(e){e.JOIN_SESSION="joinSession",e.ACCEPT_DROPIN="acceptDropin",e.SET_STATUS_TYPE="setStatusType",e.SET_DATA="setData",e.GET_DATA="getData",e.GET_STATUS_TYPE="getStatusType",e.GET_VIDEO_DATA="getVideoData",e.LOAD_SESSION="loadSession",e.NO_SESSION_DATA="noSessionData",e.ON_NOTIF="onNotif",e.FORWARD_TO_SIDEBAR="forwardToSidebar",e.TEARDOWN="teardown",e.ON_VIDEO_UPDATE="onVideoUpdate",e.SOCKET_LOST_CONNECTION="socketLostConnection",e.REBOOT="socketReconnect",e.LOG_EVENT="logEvent",e.LOG_EXPERIMENT="logExperiment",e.STAY_ALIVE="stayAlive",e.LOAD_CHAT_WINDOW="loadChatWindow",e.RESET_CHAT_WINDOW="resetChatWindow",e.HIDE_CHAT_WINDOW="hideChatWindow",e.SET_USER_PRESENCE="setUserPresence",e.TOGGLE_OPEN_PARTY="toggleOpenParty",e.GET_ACTIVE_PARTY="getActiveParty",e.GET_TAB_ID="getTabId",e.SET_ACTIVE_PARTY="setActiveParty",e.FULLSCREEN_WINDOW="fullscreenWindow",e.MAX_WINDOW="maxWindow",e.GET_EXPERIMENT_FLAG="getExpFlag",e.USER_LIST="userList",e.USER_AUTHENTICATED="userAuthenticated",e.BLOCK_CSP="blockCSP",e.REDIRECT_DATA_SET="redirectDataSet",e.LOAD_NETFLIX_DATA="loadNetflixData"}(o||(o={}))},7878:(e,n,t)=>{var o;t.d(n,{q:()=>o}),function(e){e.SET_USER_LIST="setUserList",e.SET_CONNECTION_ID="setConnectionId",e.LOAD_INIT_DATA="loadInitData",e.SET_PAGE_TITLE="setPageTitle",e.ADD_GIF_MESSAGE="addGifMessage",e.SIDEBAR_MESSAGING_READY="sidebarMessagingReady",e.RESET_VIEW="resetView",e.HIDE_CHAT="hideChat",e.ON_UPDATE_SETTINGS="onUpdateSettings",e.PREVIEW_REACTION="previewReaction",e.UPDATE_SETTINGS="updateSettings",e.SET_REACTIONS_ACTIVE="setReactionsActive",e.ON_FOCUS="onSidebarFocus",e.SET_USER_ICON_URL="setUserIconUrl",e.ADD_MESSAGE="addMessage",e.CLEAR_MESSAGES="clearMessages",e.SET_PRESENCE_MESSAGE="setPresenceMessage",e.ON_PAGE_CLICK="onPageClick",e.ON_PURCHASE="onPurchase",e.DISPLAY_MODAL="displayModal",e.OPEN_TAB="openTab",e.ON_CHROME_STORAGE_UPDATE="onChromeStorageUpdate",e.ON_WEB_RTC="onWebRTC"}(o||(o={}))},3121:(e,n,t)=>{t.d(n,{a:()=>L});const o="Failed to read chrome storage. Please refresh the page and try again";var i=t(2352),r=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const c=new class{getItemAsync(e){return r(this,void 0,void 0,(function*(){return(yield chrome.storage.local.get(e))[e]}))}getItemsAsync(e){return r(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),t(new Error(o))):n(e)}))}))}))}getStorageUse(){return r(this,void 0,void 0,(function*(){return new Promise(((e,n)=>{chrome.storage.local.getBytesInUse(null,(t=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),n(new Error(o))):e(t)}))}))}))}getAllItemsAsync(){return r(this,void 0,void 0,(function*(){if(i.$M){return yield browser.storage.local.get()}return new Promise(((e,n)=>{chrome.storage.local.get(null,(t=>{chrome.runtime.lastError?(console.log(chrome.runtime.lastError),n(new Error(o))):e(t)}))}))}))}};Object.freeze(c);const s=c;var a=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const d=new class{setItemsAsync(e){return a(this,void 0,void 0,(function*(){return new Promise(((n,t)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?t(new Error("Failed to write to chrome storage. Please refresh the page and try again")):n()}))}))}))}};Object.freeze(d);const u=d;var l,f=t(3752);!function(e){e.REGISTER="register",e.PARTY_START="party_start",e.PARTY_JOIN="party_join",e.PARTY_END="party_end",e.PARTY_SHARE="party_share"}(l||(l={}));var v=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const h=new class{getRedirectDataForTabAsync(e){return v(this,void 0,void 0,(function*(){const n=(yield s.getItemsAsync([f.zM])).redirectDataMap,t=this.u(e);if(n&&n[t]){const e=n[t];if(this.l(e))return e}}))}deleteRedirectDataForTabAsync(e){return v(this,void 0,void 0,(function*(){const n=(yield s.getItemsAsync([f.zM])).redirectDataMap,t=this.u(e);n&&n[t]&&delete n[t],yield u.setItemsAsync({[f.zM]:n})}))}u(e){return e}storeRedirectDataForTabAsync(e,n){return v(this,void 0,void 0,(function*(){console.log("store data for tab "+e);const t=this.u(n);let o=yield s.getItemsAsync([f.zM]);o[t]=e,o=this.v(o),yield u.setItemsAsync({[f.zM]:o})}))}v(e){return function(e,n){const t={};let o;for(o in e)e.hasOwnProperty(o)&&n(e[o])&&(t[o]=e[o]);return t}(e,this.l)}l(e){const n=e.date;return void 0!==n&&"number"==typeof n&&n<=Date.now()&&Date.now()-n<f.wp}};Object.freeze(h);const m=h,w={Q7:["*://*/*"]};var y=t(2390),p=t(8030),g=t(5462);class b extends p.s{constructor(e,n,t){super(e,n,g.M.LOG_EVENT),this.data=t,this.sender=e,this.target=n}}var x,S=t(6269);class T extends p.s{constructor(e,n,t){super(e,n,g.M.LOG_EXPERIMENT),this.data=t}}!function(e){e.DO_AUTH_SIGN_IN="doAuthSignIn",e.DO_APPLE_SIGN_IN="doAppleSignIn",e.GET_AUTH_TOKEN="getAuthToken",e.SIGN_OUT="signOut"}(x||(x={}));var P,A=t(7503);class D extends A.Q{constructor(e,n,t){super(e,n,t),this.type=t}}class I extends D{constructor(e,n){super(e,n,x.DO_AUTH_SIGN_IN)}}class k extends D{constructor(e,n){super(e,n,x.GET_AUTH_TOKEN)}}class _ extends D{constructor(e,n){super(e,n,x.SIGN_OUT)}}class E extends p.s{constructor(e,n){super(e,n,g.M.GET_ACTIVE_PARTY)}}class O extends p.s{constructor(e,n,t){super(e,n,g.M.ACCEPT_DROPIN),this.data=t}}!function(e){e.WITH_ACTIVITY="with_activity",e.NO_ACTIVITY="no_activity",e.OFFLINE="offline"}(P||(P={}));class M extends p.s{constructor(e,n,t){super(e,n,g.M.SET_STATUS_TYPE),this.data=t}}class C extends p.s{constructor(e,n,t){super(e,n,g.M.SET_DATA),this.data=t}}class R extends p.s{constructor(e,n,t){super(e,n,g.M.GET_DATA),this.data=t}}var j=t(7878),G=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};const N="https://www.netflix.com/watch/*";let F,U,$="new";function V(e){return"https://www.tele.pe"===e.origin&&($="old"),function(e){if(null!=f.Ts.find((n=>e.origin===`chrome-extension://${n}`)))return!0;const n=e.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/);return null!=n}(e)}function L(e){var n;try{if(V(e)){const n=e.data;if(n&&n.type&&!n.from_connect){const t=function(e){return n=>{var t;const o=e.data,r=e.data.callbackId;if(o.callbackId){const t={callbackId:r,data:n,from_connect:!0};try{i.Yw?window.postMessage(t,e.origin):window.parent.postMessage(t,e.origin)}catch(e){}}else null===(t=window.parent)||void 0===t||t.postMessage(Object.assign(Object.assign({},n),{from_connect:!0}),e.origin)}}(e);n.target===y.gR||n.target===y.Pm?function(e,n){G(this,void 0,void 0,(function*(){const t=yield S.A.i(e);n(t)}))}(n,t):"SetRedirectData"==n.type?(console.log("Got setRedirectData message",n),i.$M&&S.A.i({sender:y.pr,target:y.Pm,type:g.M.BLOCK_CSP}),H(n.data,t)):n.sessionId?H(n,t):"GetPermissions"===n.type?function(e,n){G(this,void 0,void 0,(function*(){const t=yield W(),o=t||(yield function(e){return G(this,void 0,void 0,(function*(){return new Promise((e=>{var n;const t=()=>G(this,void 0,void 0,(function*(){chrome.permissions.request({origins:w.Q7},(n=>{var t;null==n&&console.log(null===(t=chrome.runtime.lastError)||void 0===t?void 0:t.message),e(n)}))}));null===(n=document.querySelector("html"))||void 0===n||n.addEventListener("click",t)}))}))}(n.site));e(o)}))}(t,n.data):"CheckHasPermissions"===n.type?W().then(t):"logEvent"===n.type?function(e,n){G(this,void 0,void 0,(function*(){const t=new b(y.pr,y.Pm,e.event);try{S.A.i(t,2500)}finally{n()}}))}(n.data,t):"logExperiment"===n.type?function(e,n){G(this,void 0,void 0,(function*(){const{experimentName:t,experimentVersion:o,event:i}=e,r=new T(y.pr,y.Pm,{experimentName:t,experimentVersion:o,eventType:i});try{yield S.A.i(r,2500)}finally{n()}}))}(n.data,t):"SetPermId"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=yield s.getAllItemsAsync();n.userId||(n.userId=e)}))}(n.data):"storeExperimentVersion"===n.type?function(e,n){var t;G(this,void 0,void 0,(function*(){const{experimentName:o,experimentVersion:i}=e,r=yield s.getItemsAsync(["experiments"]),c=null!==(t=r.experiments)&&void 0!==t?t:{};c[o]=i;try{yield u.setItemsAsync({experiments:c})}finally{n()}}))}(n.data,t):"GetPermId"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=(yield s.getAllItemsAsync()).userId;e(n)}))}(t):"GetActiveNetflixTabs"===n.type?function(e){chrome.tabs.query({url:N},(n=>{e(n)}))}(t):"CloseNetflixTabs"===n.type?function(e){chrome.tabs.query({url:N},(n=>{const t=n.map((e=>e.id)).filter((e=>!!e));chrome.tabs.remove(t),e()}))}(t):"AddSidebarHandler"===n.type?i.Yw||function(e,n){G(this,void 0,void 0,(function*(){console.log("add sidebar handler"),F=e,U=yield J(),n(U)}))}(e.origin,t):"DoGoogleAuth"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=new I(y.pr,y.Pm);yield S.A.i(n),e()}))}(t):"DoSignOut"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=new _(y.pr,y.Pm);yield S.A.i(n),e()}))}(t):"GetAuthToken"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=new k(y.pr,y.Pm),t=yield S.A.i(n);e(t)}))}(t):"LoadSessionTab"===n.type?function(e,n){G(this,void 0,void 0,(function*(){chrome.tabs.create(e.tabData,(n=>G(this,void 0,void 0,(function*(){const t=n.id;t&&(yield m.storeRedirectDataForTabAsync(e.sessionData,t))}))))}))}(n.data):"GetActiveParty"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=new E(y.pr,y.Pm),t=yield S.A.i(n);e(t)}))}(t):"AcceptDropin"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=e.sessionId;S.A.i(new O(y.pr,y.Pm,{sessionId:n}))}))}(n.data):"SetStatusType"===n.type?function(e){G(this,void 0,void 0,(function*(){const n=e.type;S.A.i(new M(y.pr,y.Pm,n))}))}(n.data):"GetStatusType"==n.type?function(e){G(this,void 0,void 0,(function*(){const n=yield S.A.i(new p.s(y.pr,y.Pm,g.M.GET_STATUS_TYPE));e(n)}))}(t):"SetData"==n.type?function(e,n){G(this,void 0,void 0,(function*(){const t=yield S.A.i(new C(y.pr,y.Pm,e));n(t)}))}(n.data,t):"GetData"==n.type?function(e,n){G(this,void 0,void 0,(function*(){const t=yield S.A.i(new R(y.pr,y.Pm,e));n(t)}))}(n.data,t):console.log("Unsupported Operation "+n.type)}}}catch(t){t&&t.message.includes("Extension context invalidated")&&(null===(n=window.top)||void 0===n||n.postMessage("tp_reload",e.origin))}}function W(){return G(this,void 0,void 0,(function*(){return new Promise((e=>{console.log("check has default permissions",w.Q7),chrome.permissions.contains({origins:w.Q7},(n=>{console.log(n),e(n)}))}))}))}function H(e,n){return G(this,void 0,void 0,(function*(){const t=yield J();t&&(yield m.storeRedirectDataForTabAsync(e,t));const{sessionId:o,service:i}=e,r={sessionId:o,eventType:`redirect-${$}-${i}-chrome`},c=new b(y.pr,y.Pm,r),s={name:"user_click",action:{description:`redirect-${$}-${i}-chrome`}},a=new b(y.pr,y.Pm,s);try{yield S.A.i(a,2500),yield S.A.i(c,2500)}finally{n("resolveRedirect")}}))}function J(){return G(this,void 0,void 0,(function*(){return yield S.A.i(new p.s(y.pr,y.Pm,g.M.GET_TAB_ID))}))}console.log("Connect Loaded",window.origin,window.location),navigator.serviceWorker&&navigator.serviceWorker.addEventListener("message",(e=>{console.log(e),parent.postMessage(e.data,"*")})),window.addEventListener("message",L,!1),S.A.addListener((function(e,n,t){var o;return e.target===y.bT&&((null===(o=n.tab)||void 0===o?void 0:o.id)===U||(i.$M||i.Yw)&&e.tabId===U)?null!=F?(window.parent.postMessage(e,F),t(),!0):(console.warn("Not ready yet"),t(),!0):(e.type===j.q.ON_PURCHASE&&null!=F&&window.parent.postMessage(e,F),!1)}))}},n={};function t(o){var i=n[o];if(void 0!==i)return i.exports;var r=n[o]={exports:{}};return e[o](r,r.exports,t),r.exports}t.d=(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),(()=>{var e,n=t(3752),o=t(2390),i=t(2352),r=t(6269),c=t(8030),s=t(5462),a=t(7878),d=t(3121),u=function(e,n,t,o){return new(t||(t=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}a((o=o.apply(e,n||[])).next())}))};function l(e){return function(e){if(null!=n.Ts.find((n=>e.origin===`chrome-extension://${n}`)))return!0;const t=e.origin.match(/^https:\/\/[^.]*\.(?:(?:tele\.pe)|(?:teleparty\.com)|(?:netflixparty\.com))$/);return null!=t}(e)}let f,v;console.log("Detect loaded");const h=(e,n,t)=>{var r;return e.target===o.bT&&((null===(r=n.tab)||void 0===r?void 0:r.id)===v||(i.$M||i.Yw)&&e.tabId===v)?null!=f?(window.postMessage(e,f),t(),!0):(console.warn("Not ready yet"),t(),!0):(e.type===a.q.ON_PURCHASE&&null!=f&&window.parent.postMessage(e,f),!1)};(null===(e=window.teleparty)||void 0===e?void 0:e.detectScriptInjected)||(window.teleparty||(window.teleparty={}),window.teleparty.detectScriptInjected=!0,i.Yw&&r.A.addListener(h),function(){window.addEventListener("message",(e=>u(this,void 0,void 0,(function*(){var n;if(e.source===window&&"from-tp-website"===(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.direction)&&"GetExtensionId"===e.data.message){console.log("respond");const n=chrome.runtime.getURL("");window.postMessage({direction:"from-tp-content",message:"SetExtensionId",extensionId:n.substring(0,n.length-1)},e.origin)}if(i.Yw&&l(e)){const n=e.data,t=function(e){return n=>{var t;if(e.data.callbackId){const t={callbackId:e.data.callbackId,data:n,from_connect:!0};try{i.Yw?window.postMessage(t,e.origin):window.parent.postMessage(t,e.origin)}catch(e){}}else i.Yw?window.postMessage(Object.assign(Object.assign({},n),{from_connect:!0}),e.origin):null===(t=window.parent)||void 0===t||t.postMessage(Object.assign(Object.assign({},n),{from_connect:!0}),e.origin)}}(e);if(n&&n.type&&!n.from_connect){if("AddSidebarHandler"===n.type)return f=e.origin,v=yield function(){return u(this,void 0,void 0,(function*(){return yield r.A.i(new c.s(o.pr,o.Pm,s.M.GET_TAB_ID))}))}(),void t(v);n.sender!==o.pr&&n.target!==o.Pm&&n.target!==o.Ty||(0,d.a)(e)}}}))))}())})()})();